def handle_text(update, context):
    chat_id = update.message.chat_id
    text = update.message.text.strip().lower()

    # Initialize context for user
    if chat_id not in USER_CONTEXT:
        USER_CONTEXT[chat_id] = {
            "last_stock": None,
            "last_topic": None
        }

    ctx = USER_CONTEXT[chat_id]

    # 1Ô∏è‚É£ Greeting
    if text in ["hi", "hello", "hey"]:
        update.message.reply_text(
            "Hi üëã I remember context.\n\n"
            "‚Ä¢ Say a stock name (CONCOR, RELIANCE)\n"
            "‚Ä¢ Then ask F&O / news / impact\n\n"
            "Example:\n"
            "CONCOR ‚Üí F&O"
        )
        return

    # 2Ô∏è‚É£ Stock name
    if text.isalpha() and len(text) <= 12:
        symbol = text.upper()
        ctx["last_stock"] = symbol
        ctx["last_topic"] = "stock"

        holiday, _ = is_holiday()
        if not holiday:
            try:
                price = live_price(symbol)
                update.message.reply_text(
                    f"üìä {symbol} LIVE PRICE\n\n"
                    f"‚Çπ {price}\n\n"
                    "Now you can ask:\n"
                    "‚Ä¢ F&O\n"
                    "‚Ä¢ News impact\n"
                    "‚Ä¢ Monday outlook"
                )
                return
            except Exception:
                pass

        update.message.reply_text(get_stock_analysis(symbol))
        return

    # 3Ô∏è‚É£ F&O follow-up (USES remembered stock)
    if "f&o" in text or "fno" in text or "expiry" in text:
        if ctx["last_stock"]:
            update.message.reply_text(
                f"üìà F&O View for {ctx['last_stock']}\n\n"
                "‚Ä¢ Best before expiry day\n"
                "‚Ä¢ Avoid expiry-day decay\n"
                "‚Ä¢ Trade with sector trend\n\n"
                "‚ö† Risk-managed planning"
            )
        else:
            update.message.reply_text(
                "Please tell me the stock name first (example: CONCOR)"
            )
        return

    # 4Ô∏è‚É£ Macro / RBI / Global / Crude / Dollar
    macro_keywords = [
        "rbi", "repo", "rate",
        "govt", "budget",
        "global", "us market", "dow", "nasdaq",
        "crude", "oil",
        "dollar", "bond", "yield"
    ]

    if any(k in text for k in macro_keywords):
        ctx["last_topic"] = "macro"
        update.message.reply_text(
            "üåç Macro Impact Analysis\n\n"
            "‚Ä¢ Crude ‚Üë ‚Üí inflation pressure\n"
            "‚Ä¢ Dollar ‚Üë ‚Üí FII outflow risk\n"
            "‚Ä¢ Bond yields ‚Üë ‚Üí equity pressure\n\n"
            "You can now ask:\n"
            "‚Ä¢ Impact on Monday\n"
            "‚Ä¢ Impact on my stock"
        )
        return

    # 5Ô∏è‚É£ Impact follow-up
    if "impact" in text or "monday" in text or "effect" in text:
        if ctx["last_stock"]:
            update.message.reply_text(
                f"üìä Expected Impact on {ctx['last_stock']}\n\n"
                "‚Ä¢ Global cues may cause gap-up/down\n"
                "‚Ä¢ Sector reaction is key\n"
                "‚Ä¢ First 15 minutes = direction\n\n"
                "‚ö† Avoid aggressive opening trades"
            )
        else:
            update.message.reply_text(
                "Impact depends on the stock.\n"
                "Please mention the stock name."
            )
        return

    # 6Ô∏è‚É£ Fallback
    update.message.reply_text(
        "ü§î I‚Äôm not sure yet.\n\n"
        "Try:\n"
        "‚Ä¢ CONCOR\n"
        "‚Ä¢ F&O\n"
        "‚Ä¢ RBI news\n"
        "‚Ä¢ Impact on Monday"
    )
