def handle_text(update, context):
    text = update.message.text.strip().lower()

    # 1Ô∏è‚É£ Greeting
    if text in ["hi", "hello", "hey"]:
        update.message.reply_text(
            "Hi üëã How can I help you today?\n\n"
            "‚Ä¢ Type a stock name (RELIANCE, CONCOR)\n"
            "‚Ä¢ Ask about market / F&O / RBI / global news"
        )
        return

    # 2Ô∏è‚É£ Detect stock symbol (simple & safe)
    symbol = text.upper()
    is_stock = symbol.isalpha() and len(symbol) <= 12

    # 3Ô∏è‚É£ Market / F&O questions
    market_keywords = [
        "market", "f&o", "fn0", "expiry",
        "nifty", "banknifty",
        "rbi", "govt", "government",
        "global", "us market", "dow", "nasdaq"
    ]

    if any(k in text for k in market_keywords):
        update.message.reply_text(
            get_market_context_analysis()
        )
        return

    # 4Ô∏è‚É£ Stock analysis (works even on Sunday)
    if is_stock:
        try:
            analysis = get_stock_analysis(symbol)
            update.message.reply_text(analysis)
            return
        except Exception:
            pass

    # 5Ô∏è‚É£ Fallback
    update.message.reply_text(
        "‚ùì I didn‚Äôt understand that.\n\n"
        "Try:\n"
        "‚Ä¢ RELIANCE\n"
        "‚Ä¢ CONCOR\n"
        "‚Ä¢ Market outlook\n"
        "‚Ä¢ RBI news"
    )
