def handle_text(update, context):
    chat_id = update.message.chat_id
    text = update.message.text.strip().lower()

    # Init context
    if chat_id not in USER_CONTEXT:
        USER_CONTEXT[chat_id] = {
            "last_stock": None,
            "last_topic": None
        }

    ctx = USER_CONTEXT[chat_id]

    # 1Ô∏è‚É£ Greeting
    if text in ["hi", "hello", "hey"]:
        update.message.reply_text(
            "Hi üëã I can help with:\n\n"
            "‚Ä¢ Stock analysis (CONCOR, RELIANCE)\n"
            "‚Ä¢ F&O planning\n"
            "‚Ä¢ RBI / Govt / Global market impact\n\n"
            "Ask freely, I‚Äôll remember context üôÇ"
        )
        return

    # 2Ô∏è‚É£ Stock name detection
    if text.isalpha() and len(text) <= 12:
        symbol = text.upper()
        ctx["last_stock"] = symbol
        ctx["last_topic"] = "stock"

        holiday, _ = is_holiday()
        if not holiday:
            try:
                price = live_price(symbol)
                update.message.reply_text(
                    f"üìä {symbol} ‚Äî LIVE NSE PRICE\n\n"
                    f"‚Çπ {price}\n\n"
                    "You can ask:\n"
                    "‚Ä¢ F&O\n"
                    "‚Ä¢ News impact\n"
                    "‚Ä¢ Trend"
                )
                return
            except Exception:
                pass

        update.message.reply_text(get_stock_analysis(symbol))
        return

    # 3Ô∏è‚É£ F&O follow-up (USES LAST STOCK)
    if "f&o" in text or "fno" in text or "expiry" in text:
        if ctx["last_stock"]:
            update.message.reply_text(
                f"üìà F&O View for {ctx['last_stock']}\n\n"
                "‚Ä¢ Avoid expiry day trading\n"
                "‚Ä¢ Prefer 1‚Äì2 days before expiry\n"
                "‚Ä¢ Follow sector strength & news\n\n"
                "‚ö† Risk-managed planning only"
            )
            return
        else:
            update.message.reply_text(
                "Please tell me the stock name first (e.g. CONCOR)"
            )
            return

    # 4Ô∏è‚É£ RBI / Govt / Global news
    market_keywords = [
        "rbi", "repo", "rate",
        "govt", "budget",
        "global", "us market", "dow", "nasdaq",
        "crude", "oil",
        "dollar", "bond", "yield"
    ]

    if any(k in text for k in market_keywords):
        ctx["last_topic"] = "macro"

        update.message.reply_text(
            "üåç Macro Market Impact Analysis\n\n"
            "‚Ä¢ Crude ‚Üë ‚Üí Inflation pressure ‚Üí RBI cautious\n"
            "‚Ä¢ Dollar ‚Üë ‚Üí FII outflow risk\n"
            "‚Ä¢ Bond yields ‚Üë ‚Üí Equity valuation pressure\n\n"
            "üìå These factors can impact Monday‚Äôs market\n"
            "Ask: 'Impact on my stock?'"
        )
        return

    # 5Ô∏è‚É£ Follow-up: impact on Monday / impact on stock
    if "impact" in text or "monday" in text or "effect" in text:
        if ctx["last_stock"]:
            update.message.reply_text(
                f"üìä Expected Impact on {ctx['last_stock']}\n\n"
                "‚Ä¢ Gap-up/down depends on global cues\n"
                "‚Ä¢ Sector reaction matters more than stock alone\n"
                "‚Ä¢ Watch first 15 minutes for direction\n\n"
                "‚ö† Avoid aggressive trades at open"
            )
            return
        else:
            update.message.reply_text(
                "Impact depends on the stock.\n"
                "Please mention the stock name."
            )
            return

    # 6Ô∏è‚É£ Fallback (SMART)
    update.message.reply_text(
        "I‚Äôm not sure yet ü§î\n\n"
        "You can ask:\n"
        "‚Ä¢ A stock name (CONCOR)\n"
        "‚Ä¢ F&O\n"
        "‚Ä¢ RBI / crude / dollar impact\n"
        "‚Ä¢ Market impact on Monday"
    )
